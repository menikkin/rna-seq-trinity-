# Load libraries
library(DESeq2)
library(ggplot2)
library(pheatmap)

# Load count matrix (genes in rows, samples in columns)
counts <- read.table("gene_counts_matrix.txt", header=TRUE, row.names=1, sep="\t")

# If featureCounts generated extra columns, remove them (optional)
# counts <- counts[ , 6:ncol(counts) ]

# Load sample metadata (sample, condition)
samples <- read.csv("samples.csv", header=TRUE, row.names=1)

# Create DESeq2 dataset
dds <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = samples,
  design = ~ condition
)

# Filter out low-count genes
dds <- dds[rowSums(counts(dds)) > 10, ]

# Run DESeq2
dds <- DESeq(dds)

# Extract results (Treated vs Control)
res <- results(dds, contrast = c("condition", "Treated", "Control"))
res <- res[order(res$padj), ]

# Save results
write.csv(as.data.frame(res), "DESeq2_results.csv")

# MA plot
plotMA(res, ylim=c(-5,5))

# Volcano plot
res$log10padj <- -log10(res$padj)
ggplot(res, aes(log2FoldChange, log10padj)) +
  geom_point(alpha=0.4) +
  theme_bw() +
  xlab("log2 Fold Change") +
  ylab("-log10 adjusted p-value")

# Variance Stabilizing Transform (VST)
vsd <- vst(dds, blind=FALSE)

# PCA plot
pcaData <- plotPCA(vsd, intgroup="condition", returnData=TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))
ggplot(pcaData, aes(PC1, PC2, color=condition)) +
  geom_point(size=4) +
  theme_bw() +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance"))

# Heatmap of top 50 DE genes
top50 <- head(order(res$padj), 50)
mat <- assay(vsd)[top50, ]
pheatmap(mat, scale="row", clustering_distance_rows="correlation")

# Export normalized counts
norm_counts <- counts(dds, normalized=TRUE)
write.csv(norm_counts, "DESeq2_normalized_counts.csv")
